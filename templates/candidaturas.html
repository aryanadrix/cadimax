{% extends "base.html" %}
{% block titulo %}CDM-BIÉ: Candidaturas{% endblock %}

{% block conteudo %}
<div class="container" style="max-width: 1200px; margin: auto;">
<div class="container my-4">

  <!-- Filtros -->
  <form class="row g-2 align-items-end mb-4" method="get" action="{{ url_for('rota_candidaturas.candidaturas') }}">
    <div class="col-12 col-md-4">
      <label class="form-label fw-semibold">Município</label>
      <select name="municipio" class="form-select">
        <option value="">— Todos —</option>
        {% for m in municipios %}
        <option value="{{ m }}" {% if filtro_municipio==m %}selected{% endif %}>{{ m }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-12 col-md-4">
      <label class="form-label fw-semibold">Vaga</label>
      <select name="vaga" class="form-select">
        <option value="">— Todas —</option>
        {% for v in vagas %}
        <option value="{{ v }}" {% if filtro_vaga==v %}selected{% endif %}>{{ v }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-12 col-md-4">
      <button class="btn btn-primary w-100">Aplicar Filtros</button>
    </div>
  </form>

  <!-- KPI Cards -->
  <div class="row g-3 mb-4 text-center">
    <div class="col-12 col-md-4">
      <div class="p-3 border rounded bg-light">
        <div class="fw-bold fs-6 text-muted">Total de Candidatos</div>
        <div id="kpi-total" class="fs-2 fw-bold">—</div>
      </div>
    </div>
    <div class="col-6 col-md-4">
      <div class="p-3 border rounded bg-light">
        <div class="fw-bold fs-6 text-muted">% Com Documentos Completos</div>
        <div id="kpi-perc" class="fs-2 fw-bold">—</div>
      </div>
    </div>
    <div class="col-6 col-md-4">
      <div class="p-3 border rounded bg-light">
        <div class="fw-bold fs-6 text-muted">Completos vs Documentos em Falta</div>
        <div id="kpi-bar" class="small">Completos: — | Incompletos: —</div>
      </div>
    </div>
  </div>

  <!-- Gráficos -->
  <div class="row g-4 mb-4">
    <div class="col-12 col-lg-6">
      <div class="p-3 border rounded">
        <div class="fw-semibold mb-2">Distribuição por Vaga</div>
        <canvas id="chartVaga" height="180"></canvas>
      </div>
    </div>
    <div class="col-12 col-lg-6">
      <div class="p-3 border rounded">
        <div class="fw-semibold mb-2">Distribuição por Município</div>
        <canvas id="chartMunicipio" height="180"></canvas>
      </div>
    </div>
  </div>

  <!-- Tabela -->
  <div class="p-3 border rounded">
    <div class="fw-semibold mb-2">Registos</div>
    <div class="table-responsive" style="max-height: 55vh; overflow:auto;">
      <table class="table table-striped align-middle">
        <thead class="table-light">
          <tr>
            <th>#</th>
            <th>Nome</th>
            <th>Município</th>
            <th>Comuna</th>
            <th>Vaga</th>
            <th>Documentos</th>
            <th>Completo</th>
          </tr>
        </thead>
        <tbody>
          {% for c in linhas %}
          <tr>
            <td>{{ c.id }}</td>
            <td>{{ c.nome or '—' }}</td>
            <td>{{ c.municipio or '—' }}</td>
            <td>{{ c.comuna or '—' }}</td>
            <td>{{ c.vaga or '—' }}</td>
            <td>{{ c.documentos or '—' }}</td>
            <td>
              {% if c.completo %}
                <span class="badge text-bg-success">Sim</span>
              {% else %}
                <span class="badge text-bg-secondary">Não</span>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <div class="small text-muted mt-2">Mostrando no máximo 500 linhas.</div>
  </div>

</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const params = new URLSearchParams(window.location.search);
  const dataUrl = "{{ url_for('rota_candidaturas.candidaturas_data') }}" + (params.toString() ? "?" + params.toString() : "");

  let chartVaga, chartMunicipio;

  function renderBars(ctxId, labels, values, instanceRef) {
    const ctx = document.getElementById(ctxId).getContext('2d');
    if (instanceRef && instanceRef.destroy) instanceRef.destroy();
    return new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{ label: 'Total', data: values }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: { y: { beginAtZero: true } }
      }
    });
  }

  fetch(dataUrl)
    .then(r => r.json())
    .then(d => {
      // KPIs
      document.getElementById('kpi-total').textContent = d.total ?? 0;
      const completos = d.completos ?? 0;
      const incompletos = d.incompletos ?? 0;
      const perc = d.total > 0 ? Math.round(100 * completos / d.total) : 0;
      document.getElementById('kpi-perc').textContent = perc + '%';
      document.getElementById('kpi-bar').textContent = `Completos: ${completos} | Incompletos: ${incompletos}`;

      // Gráficos
      chartVaga = renderBars('chartVaga',
        (d.por_vaga || []).map(x => x.label),
        (d.por_vaga || []).map(x => x.valor),
        chartVaga
      );
      chartMunicipio = renderBars('chartMunicipio',
        (d.por_municipio || []).map(x => x.label),
        (d.por_municipio || []).map(x => x.valor),
        chartMunicipio
      );
    })
    .catch(() => {
      document.getElementById('kpi-total').textContent = '0';
      document.getElementById('kpi-perc').textContent = '0%';
      document.getElementById('kpi-bar').textContent = 'Completos: 0 | Incompletos: 0';
    });
</script>
    </div>
{% endblock %}